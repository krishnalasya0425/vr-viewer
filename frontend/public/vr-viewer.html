<!-- <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>VR Viewer</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #status {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px;
      font-family: Arial;
      z-index: 9999;
      white-space: pre-line;
    }
  </style>
</head>

<body>
  <a-scene webxr="requiredFeatures: local-floor" vr-mode-ui="enabled: true">
    <a-sky color="#ECECEC"></a-sky>
    <a-light type="ambient" intensity="0.5"></a-light>
    <a-light type="directional" position="1 3 -2" intensity="0.8"></a-light>
    <a-plane rotation="-90 0 0" width="10" height="10" color="#ccc" position="0 0 0"></a-plane>

    <a-entity id="model" gltf-model="" position="0 1.5 -3" rotation="0 0 0" scale="1 1 1" shadow="receive: true">
    </a-entity>

    <a-entity id="leftController" tracked-controls="hand: left" visible="false"></a-entity>
    <a-entity id="rightController" tracked-controls="hand: right" visible="false"></a-entity>
  </a-scene>

  <div id="status">Waiting for VR input...</div>

  <script>
    const status = document.getElementById('status');
    const modelEl = document.getElementById('model');
    const leftController = document.getElementById('leftController');
    const rightController = document.getElementById('rightController');

    // Get model URL from query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const modelUrl = urlParams.get('model');

    if (modelUrl) {
      modelEl.setAttribute('gltf-model', `url(${modelUrl})`);
modelEl.setAttribute('crossorigin', 'anonymous');

    } else {
      status.innerText = 'No model specified in URL';
    }

    // Scale and center model on load
    modelEl.addEventListener('model-loaded', () => {
      const box = new THREE.Box3().setFromObject(modelEl.object3D);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());

      // Rescale to a reasonable size
      const scaleMultiplier = 10; // Increase this to make the car larger
      const scale = scaleMultiplier / size;
      modelEl.setAttribute('scale', { x: scale, y: scale, z: scale });


      // Offset to center
      modelEl.object3D.position.sub(center);
      modelEl.object3D.position.y += 1.5; // Raise to eye level
    });

    function getGamepad(controllerEl) {
      const controller = controllerEl.components['tracked-controls']?.controller;
      return controller && controller.gamepad ? controller.gamepad : null;
    }

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    let targetPos = { x: 0, y: 1.5, z: -3 };
    let targetRot = { x: 0, y: 0, z: 0 };

    function pollControllers() {
      const leftGamepad = getGamepad(leftController);
      const rightGamepad = getGamepad(rightController);

      let dx = 0, dz = 0, rotate = false;

      if (rightGamepad) {
        dx += rightGamepad.axes[2] || 0;
        dz += rightGamepad.axes[3] || 0;
        rotate = rightGamepad.buttons[0]?.pressed || rightGamepad.buttons[1]?.pressed;
      }

      if (leftGamepad) {
        dx += leftGamepad.axes[2] || 0;
        dz += leftGamepad.axes[3] || 0;
        rotate = rotate || leftGamepad.buttons[0]?.pressed || leftGamepad.buttons[1]?.pressed;
      }

      if (dx !== 0 || dz !== 0) {
        targetPos.x += dx * 0.08;
        targetPos.z += dz * 0.08;
      }

      if (rotate) {
        targetRot.y += 3;
      }

      const currentPos = modelEl.getAttribute('position');
      const currentRot = modelEl.getAttribute('rotation');

      modelEl.setAttribute('position', {
        x: lerp(currentPos.x, targetPos.x, 0.1),
        y: currentPos.y,
        z: lerp(currentPos.z, targetPos.z, 0.1)
      });

      modelEl.setAttribute('rotation', {
        x: currentRot.x,
        y: lerp(currentRot.y, targetRot.y, 0.1),
        z: currentRot.z
      });

      status.innerText =
        `L Gamepad: ${leftGamepad ? 'Yes' : 'No'} | R Gamepad: ${rightGamepad ? 'Yes' : 'No'}\n` +
        `dx: ${dx.toFixed(2)} | dz: ${dz.toFixed(2)} | Rotating: ${rotate}`;
    }

    setInterval(pollControllers, 100);
  </script>
</body>

</html> -->


<!-- <!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Model Viewer</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; background: #000; }
    </style>
  </head>
  <body>
    <a-scene background="color: #ECECEC">
      <a-entity id="model" position="0 1 -3"></a-entity>
      <a-sky color="#ECECEC"></a-sky>
      <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
      const params = new URLSearchParams(window.location.search);
      const modelUrl = params.get("model");

      if (modelUrl) {
        const modelEl = document.getElementById("model");
        modelEl.setAttribute("gltf-model", `url(${modelUrl})`);
        modelEl.setAttribute("animation-mixer", "");
        modelEl.setAttribute("crossorigin", "anonymous");
      } else {
        alert("No model specified. Use ?model=... in URL");
      }
    </script>
  </body>
</html> -->
<!-- <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>VR Model Viewer</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }

    #status {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px;
      font-family: Arial;
      z-index: 9999;
      white-space: pre-line;
    }
  </style>
</head>

<body>
  <a-scene webxr="requiredFeatures: local-floor" vr-mode-ui="enabled: true">
    <a-sky color="#ECECEC"></a-sky>
    <a-light type="ambient" intensity="0.5"></a-light>
    <a-light type="directional" position="1 3 -2" intensity="0.8"></a-light>
    <a-plane rotation="-90 0 0" width="10" height="10" color="#ccc" position="0 0 0"></a-plane>

    <a-entity id="model" position="0 1.5 -3" rotation="0 0 0" scale="1 1 1" shadow="receive: true"></a-entity>

    <a-entity id="leftController" tracked-controls="hand: left" visible="false"></a-entity>
    <a-entity id="rightController" tracked-controls="hand: right" visible="false"></a-entity>
  </a-scene>

  <div id="status">Waiting for VR input...</div>

  <script>
    const status = document.getElementById('status');
    const modelEl = document.getElementById('model');
    const leftController = document.getElementById('leftController');
    const rightController = document.getElementById('rightController');

    // Get model URL from query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const modelUrl = urlParams.get('model');

    if (modelUrl) {
      modelEl.setAttribute('gltf-model', `url(${modelUrl})`);
      modelEl.setAttribute('crossorigin', 'anonymous');
    } else {
      status.innerText = 'No model specified in URL';
    }

    // Scale and center model on load
    modelEl.addEventListener('model-loaded', () => {
      const box = new THREE.Box3().setFromObject(modelEl.object3D);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());

      // Rescale to a reasonable size
      const scaleMultiplier = 10;
      const scale = scaleMultiplier / size;
      modelEl.setAttribute('scale', { x: scale, y: scale, z: scale });

      // Offset to center
      modelEl.object3D.position.sub(center);
      modelEl.object3D.position.y += 1.5; // Raise to eye level
    });

    function getGamepad(controllerEl) {
      const controller = controllerEl.components['tracked-controls']?.controller;
      return controller && controller.gamepad ? controller.gamepad : null;
    }

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    let targetPos = { x: 0, y: 1.5, z: -3 };
    let targetRot = { x: 0, y: 0, z: 0 };

    function pollControllers() {
      const leftGamepad = getGamepad(leftController);
      const rightGamepad = getGamepad(rightController);

      let dx = 0, dz = 0, rotate = false;

      if (rightGamepad) {
        dx += rightGamepad.axes[2] || 0;
        dz += rightGamepad.axes[3] || 0;
        rotate = rightGamepad.buttons[0]?.pressed || rightGamepad.buttons[1]?.pressed;
      }

      if (leftGamepad) {
        dx += leftGamepad.axes[2] || 0;
        dz += leftGamepad.axes[3] || 0;
        rotate = rotate || leftGamepad.buttons[0]?.pressed || leftGamepad.buttons[1]?.pressed;
      }

      if (dx !== 0 || dz !== 0) {
        targetPos.x += dx * 0.08;
        targetPos.z += dz * 0.08;
      }

      if (rotate) {
        targetRot.y += 3;
      }

      const currentPos = modelEl.getAttribute('position');
      const currentRot = modelEl.getAttribute('rotation');

      modelEl.setAttribute('position', {
        x: lerp(currentPos.x, targetPos.x, 0.1),
        y: currentPos.y,
        z: lerp(currentPos.z, targetPos.z, 0.1)
      });

      modelEl.setAttribute('rotation', {
        x: currentRot.x,
        y: lerp(currentRot.y, targetRot.y, 0.1),
        z: currentRot.z
      });

      status.innerText =
        `L Gamepad: ${leftGamepad ? 'Yes' : 'No'} | R Gamepad: ${rightGamepad ? 'Yes' : 'No'}\n` +
        `dx: ${dx.toFixed(2)} | dz: ${dz.toFixed(2)} | Rotating: ${rotate}`;
    }

    setInterval(pollControllers, 100);
  </script>
</body>

</html> -->
<!-- working  -->
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>VR Model Viewer</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-orbit-controls@1.3.3/dist/aframe-orbit-controls.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #fff;
    }

    #status {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px;
      font-family: Arial;
      z-index: 9999;
    }
  </style>
</head>

<body>
  <a-scene webxr="optionalFeatures: local-floor; requiredFeatures: local-floor" vr-mode-ui="enabled: true"
    renderer="colorManagement: true; physicallyCorrectLights: true">
    <a-sky color="#ffffff"></a-sky>

    <!-- Lighting -->
    <a-light type="ambient" intensity="1.5" color="#ffffff"></a-light>
    <a-light type="directional" intensity="1" position="0 4 4" color="#ffffff"></a-light>

    <!-- Orbit camera for desktop -->
    <a-entity id="orbitCamera" camera position="0 1.6 5" look-controls="enabled: false" orbit-controls="
          target: 0 1.5 0;
          enableDamping: true;
          dampingFactor: 0.15;
          rotateSpeed: 0.25;
          zoomSpeed: 0.5;
          minDistance: 1;
          maxDistance: 10;
          enableZoom: true;
          enableRotate: true;
        "></a-entity>

    <!-- Model -->
    <a-entity id="model" position="0 0 0" rotation="0 180 0" scale="1 1 1"></a-entity>

    <!-- VR Controllers -->
    <a-entity id="leftController" tracked-controls="hand: left" visible="false"></a-entity>
    <a-entity id="rightController" tracked-controls="hand: right" visible="false"></a-entity>
  </a-scene>

  <div id="status">Waiting for VR input...</div>

  <script>
    const status = document.getElementById('status');
    const modelEl = document.getElementById('model');
    const leftController = document.getElementById('leftController');
    const rightController = document.getElementById('rightController');

    const urlParams = new URLSearchParams(window.location.search);
    const modelUrl = urlParams.get('model');

    if (modelUrl) {
      modelEl.setAttribute('gltf-model', `url(${modelUrl})`);
      modelEl.setAttribute('crossorigin', 'anonymous');
    } else {
      status.innerText = 'No model specified in URL';
    }

    let box, center, size, scale;
    let targetPos = null; // Initialize later
    let targetRot = { x: 0, y: 0, z: 0 };

    modelEl.addEventListener('model-loaded', () => {
      box = new THREE.Box3().setFromObject(modelEl.object3D);
      size = box.getSize(new THREE.Vector3());
      center = box.getCenter(new THREE.Vector3());

      const maxDim = Math.max(size.x, size.y, size.z);
      scale = 7 / maxDim;

      modelEl.setAttribute('scale', { x: scale, y: scale, z: scale });
      modelEl.object3D.position.sub(center); // Center it first

      const defaultY = 1.5;
      const distance = size.z * scale + 4;
      const height = defaultY - (size.y * scale * 0.5);

      modelEl.object3D.position.set(0, height, -distance);
      targetPos = { x: 0, y: height, z: -distance };

      status.innerText = 'Model loaded & positioned';
    });


    AFRAME.scenes[0].renderer.xr.addEventListener('sessionstart', () => {
      setTimeout(() => {
        const xrCam = document.querySelector('[camera]').object3D;
        const userY = xrCam.position.y;

        if (!center || !size) return;

        const distance = size.z * scale + 4; // farther from user
        const height = userY - (size.y * scale * 0.5);

        modelEl.object3D.position.set(0, height, -distance);
        targetPos = { x: 0, y: height, z: -distance }; // Update controller target

        status.innerText += `\nModel placed at Z: -${distance.toFixed(2)} | Y: ${height.toFixed(2)}`;
      }, 800);
    });

    function getGamepad(controllerEl) {
      return controllerEl.components['tracked-controls']?.controller?.gamepad || null;
    }

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function pollControllers() {
      if (!targetPos) return; // Wait for VR placement

      const left = getGamepad(leftController);
      const right = getGamepad(rightController);

      let dx = 0, dz = 0, rotate = false;

      if (right) {
        dx += right.axes[2] || 0;
        dz += right.axes[3] || 0;
        rotate = right.buttons[0]?.pressed || right.buttons[1]?.pressed;
      }
      if (left) {
        dx += left.axes[2] || 0;
        dz += left.axes[3] || 0;
        rotate = rotate || left.buttons[0]?.pressed || left.buttons[1]?.pressed;
      }

      if (dx || dz) {
        targetPos.x += dx * 0.08;
        targetPos.z += dz * 0.08;
      }

      if (rotate) targetRot.y += 3;

      const currentPos = modelEl.getAttribute('position');
      const currentRot = modelEl.getAttribute('rotation');

      modelEl.setAttribute('position', {
        x: lerp(currentPos.x, targetPos.x, 0.1),
        y: currentPos.y,
        z: lerp(currentPos.z, targetPos.z, 0.1),
      });

      modelEl.setAttribute('rotation', {
        x: currentRot.x,
        y: lerp(currentRot.y, targetRot.y, 0.1),
        z: currentRot.z,
      });

      status.innerText = `L: ${!!left} | R: ${!!right} | dx: ${dx.toFixed(2)} | dz: ${dz.toFixed(2)} | Rotating: ${rotate}`;
    }

    setInterval(pollControllers, 100);
  </script>
</body>

</html>